#!/bin/bash
# Post-install script for cassh PKG
# Runs after the app is installed to /Applications

set -e

APP_PATH="/Applications/cassh.app"
POLICY_PATH="$APP_PATH/Contents/Resources/cassh.policy.toml"

# Main app LaunchAgent (keeps app running)
LAUNCH_AGENT_SRC="$APP_PATH/Contents/Resources/com.shawnschwartz.cassh.plist"
LAUNCH_AGENT_DST="/Library/LaunchAgents/com.shawnschwartz.cassh.plist"
LABEL="com.shawnschwartz.cassh"

# Key rotation LaunchAgent (runs hourly in background)
ROTATE_AGENT_SRC="$APP_PATH/Contents/Resources/com.shawnschwartz.cassh.rotate.plist"
ROTATE_AGENT_DST="/Library/LaunchAgents/com.shawnschwartz.cassh.rotate.plist"
ROTATE_LABEL="com.shawnschwartz.cassh.rotate"

# Make policy file immutable
if [ -f "$POLICY_PATH" ]; then
  chmod 444 "$POLICY_PATH"
  chflags uchg "$POLICY_PATH" 2>/dev/null || true
fi

# Install main app LaunchAgent for all users (requires admin)
if [ -f "$LAUNCH_AGENT_SRC" ]; then
  if cp "$LAUNCH_AGENT_SRC" "$LAUNCH_AGENT_DST" 2>/dev/null; then
    chmod 644 "$LAUNCH_AGENT_DST" 2>/dev/null || true
    chown root:wheel "$LAUNCH_AGENT_DST" 2>/dev/null || true
  fi
fi

# Install key rotation LaunchAgent for all users
if [ -f "$ROTATE_AGENT_SRC" ]; then
  if cp "$ROTATE_AGENT_SRC" "$ROTATE_AGENT_DST" 2>/dev/null; then
    chmod 644 "$ROTATE_AGENT_DST" 2>/dev/null || true
    chown root:wheel "$ROTATE_AGENT_DST" 2>/dev/null || true
  fi
fi

# Get current console user
CONSOLE_USER=$(stat -f "%Su" /dev/console)
CONSOLE_UID=$(id -u "$CONSOLE_USER" 2>/dev/null || echo "")

# Validate username format (alphanumeric, underscore, hyphen, dot)
if ! echo "$CONSOLE_USER" | grep -qE '^[a-zA-Z0-9._-]+$'; then
  echo "Error: Invalid console username format" >&2
  CONSOLE_USER=""
  CONSOLE_UID=""
fi

if [ -n "$CONSOLE_USER" ] && [ "$CONSOLE_USER" != "root" ] && [ -n "$CONSOLE_UID" ]; then
  # Create log directory for console user
  # Use dscl to safely get home directory (more secure than sh -c)
  CONSOLE_HOME=$(dscl . -read "/Users/$CONSOLE_USER" NFSHomeDirectory 2>/dev/null | awk '{print $2}')
  if [ -n "$CONSOLE_HOME" ] && [ -d "$CONSOLE_HOME" ]; then
    PARENT_LOG_DIR="$CONSOLE_HOME/Library/Logs"
    # Ensure parent log directory exists and is usable
    if [ ! -d "$PARENT_LOG_DIR" ]; then
      if ! mkdir -p "$PARENT_LOG_DIR" 2>/dev/null; then
        echo "Warning: Failed to create parent log directory $PARENT_LOG_DIR" >&2
      fi
    fi

    if [ -d "$PARENT_LOG_DIR" ] && [ -w "$PARENT_LOG_DIR" ]; then
      LOG_DIR="$PARENT_LOG_DIR/cassh"
      if ! sudo -u "$CONSOLE_USER" mkdir -p "$LOG_DIR"; then
        echo "Warning: Failed to create log directory $LOG_DIR" >&2
      fi
    else
      echo "Warning: Parent log directory $PARENT_LOG_DIR is not writable; skipping log directory creation." >&2
    fi
  fi
  
  # Kill any existing cassh process
  pkill -f "cassh.app" 2>/dev/null || true
  sleep 1

  # Unload old LaunchAgents if exist (ignore errors)
  unload_launch_agent "$LABEL" "$LAUNCH_AGENT_DST" "$CONSOLE_USER" "$CONSOLE_UID"
  unload_launch_agent "$ROTATE_LABEL" "$ROTATE_AGENT_DST" "$CONSOLE_USER" "$CONSOLE_UID"

  # Load main app LaunchAgent for current user using modern launchctl
  # Try bootstrap first (modern), fall back to load (legacy)
  if ! launchctl bootstrap "gui/$CONSOLE_UID" "$LAUNCH_AGENT_DST" 2>/dev/null; then
    sudo -u "$CONSOLE_USER" launchctl load "$LAUNCH_AGENT_DST" 2>/dev/null || true
  fi

  # Load key rotation LaunchAgent
  if [ -f "$ROTATE_AGENT_DST" ]; then
    if ! launchctl bootstrap "gui/$CONSOLE_UID" "$ROTATE_AGENT_DST" 2>/dev/null; then
      sudo -u "$CONSOLE_USER" launchctl load "$ROTATE_AGENT_DST" 2>/dev/null || true
    fi
  fi

  # Start the app immediately
  sleep 1
  sudo -u "$CONSOLE_USER" open -a "$APP_PATH" 2>/dev/null || true
fi

exit 0
