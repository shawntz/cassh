# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

`cassh` is an SSH key and certificate manager for GitHub, supporting both personal GitHub.com accounts and GitHub Enterprise organizations.

**Two modes of operation:**

| Mode | Authentication | Server Required | Key Lifecycle |
|------|----------------|-----------------|---------------|
| **GitHub Enterprise** | SSH Certificates (CA-signed) | Yes | 12-hour validity (configurable) |
| **GitHub.com Personal** | SSH Keys (via `gh` CLI) | No | Configurable rotation (4h to 90 days) |

Users can run both modes simultaneously - enterprise for work, personal for side projects.

## Build Commands

```bash
# Install dependencies
make deps

# Build all binaries
make build

# Build individual components
make server      # cassh-server (web + CA)
make menubar     # cassh-menubar (macOS tray app)
make cli         # cassh CLI (headless)

# Run tests
make test

# Lint
make lint

# Development server (requires dev CA key)
make dev-ca      # Generate dev CA key first
make dev-server  # Run server locally on :8080

# Build distributions
make build-oss           # OSS template (config editable)
make build-enterprise    # Enterprise (locked policy)

# macOS packaging (one-liner after configuring cassh.policy.toml)
./scripts/build-release

# Or step-by-step:
make icon         # Compile .icon to Assets.car (liquid glass support)
make app-bundle   # Create cassh.app
make pkg          # Create PKG installer
make sign         # Code sign (requires APPLE_DEVELOPER_ID)
make notarize     # Notarize for Gatekeeper

# Full release
make release      # Clean, test, lint, build all artifacts
```

## Architecture

```
cmd/
  cassh-server/       # Web server: landing page + OIDC + cert signing
    templates/        # HTML templates (embedded)
    static/           # Static assets (embedded)
  cassh-menubar/      # macOS menu bar app with loopback listener
  cassh-cli/          # Headless CLI for CI/servers

internal/
  config/             # Split config: policy (immutable) + user (editable)
  ca/                 # SSH certificate generation and parsing
  oidc/               # Microsoft Entra ID authentication
  memes/              # LSP and Sloth quote rotation

packaging/macos/      # macOS distribution files
  Info.plist.template
  entitlements.plist
  com.shawnschwartz.cassh.plist  # LaunchAgent
  distribution.xml         # PKG installer
  scripts/                 # Install scripts
  resources/               # PKG resources (HTML)
  Assets.car               # Compiled icon (liquid glass, generated by `make icon`)
  cassh.icns               # Fallback icon (generated by `make icon`)
  icon/
    cassh.icon/            # Icon Composer bundle (edit in Xcode 16+)
    icon_exports/          # PNG exports from Icon Composer
```

## Configuration System

**Split config model** - policy cannot be overridden by users:

| Config | Location | Editable | Contains |
|--------|----------|----------|----------|
| Policy | `cassh.policy.toml` (bundled in app) | No | CA key, cert validity, OIDC settings, GHE URL |
| User | `~/.config/cassh/config.toml` (dotfiles) | Yes | Connections, UI prefs, refresh interval |
| User (fallback) | `~/Library/Application Support/cassh/config.toml` | Yes | Same as above (platform-specific) |

**Dotfiles support**: The app checks `~/.config/cassh/config.toml` first. If it exists, it's used as the primary config location. This makes it easy to back up your connections as part of your dotfiles. To migrate:

```bash
# Create dotfiles config directory
mkdir -p ~/.config/cassh

# Copy existing config (if any)
cp ~/Library/Application\ Support/cassh/config.toml ~/.config/cassh/config.toml
```

## Key Files

- `cassh.policy.toml` - Template policy config (fill in before enterprise build)
- `internal/config/config.go` - `LoadServerConfig()` loads config with env var overrides
- `internal/ca/ca.go` - `SignPublicKeyForGitHub()` - certificate signing with `login@HOSTNAME` extension
- `internal/oidc/oidc.go` - `StartAuth()` / `HandleCallback()` - Entra OIDC flow
- `cmd/cassh-menubar/main.go` - Menu bar app with loopback listener and URL scheme handler
- `cmd/cassh-menubar/urlhandler_darwin.go` - `cassh://` URL scheme handling for certificate installation
- `cmd/cassh-menubar/webview_darwin.go` - Native WebKit window for setup wizard (seamless titlebar, Edit menu)
- `cmd/cassh-menubar/updater.go` - GitHub Releases update checker with AppleScript dialogs
- `cmd/cassh-menubar/share_darwin.go` - Native share popup dialog with copy button
- `cmd/cassh-menubar/about_darwin.go` - Native about window
- `cmd/cassh-menubar/appvisibility_darwin.go` - Dock visibility toggle (NSApplicationActivationPolicy)

## Environment Variables

**Server (for cloud deployment):**
- `CASSH_SERVER_URL` - Public server URL (e.g., `https://cassh.onrender.com`)
- `CASSH_OIDC_CLIENT_ID` - Entra app client ID
- `CASSH_OIDC_CLIENT_SECRET` - Entra app client secret
- `CASSH_OIDC_TENANT` - Entra tenant ID
- `CASSH_OIDC_REDIRECT_URL` - OAuth callback URL (default: `{server_url}/auth/callback`)
- `CASSH_CA_PRIVATE_KEY` - CA private key content (for cloud, paste full key)
- `CASSH_CA_PRIVATE_KEY_PATH` - Path to CA private key file (for local/VPS)
- `CASSH_CERT_VALIDITY_HOURS` - Certificate validity (default: `12`)
- `CASSH_GITHUB_PRINCIPAL_SOURCE` - How to derive cert principal: `email_prefix` (default), `email`, `username`
- `CASSH_DEV_MODE` - Set to `true` to skip OIDC, use mock auth
- `CASSH_LISTEN_ADDR` - Listen address (default: `:8080`)
- `CASSH_POLICY_PATH` - Path to policy TOML (default: `cassh.policy.toml`)

**CLI:**
- `CASSH_SERVER` - Server URL for cert generation

## GitHub Actions Secrets (for releases)

- `APPLE_CERTIFICATE_BASE64` - Code signing certificate (p12, base64)
- `APPLE_CERTIFICATE_PASSWORD` - Certificate password
- `APPLE_DEVELOPER_ID` - Developer ID name
- `APPLE_ID` - Apple ID for notarization
- `APPLE_APP_PASSWORD` - App-specific password
- `APPLE_TEAM_ID` - Team ID

## Auth Flows

### Enterprise Flow (SSH Certificates)

1. User clicks terminal icon in menu bar, selects enterprise connection
2. Menubar ensures `~/.ssh/cassh_{connection}_id_ed25519` exists, reads pubkey
3. Opens browser to `https://cassh.example.com/?pubkey=<pubkey>&connection=<id>`
4. Landing page shows LSP or Sloth meme with SSO button
5. User clicks SSO → Entra OIDC flow
6. On callback, server signs cert with CA (includes `login@HOSTNAME=username` extension)
7. Browser redirects to `cassh://install-cert?cert=<base64>` URL scheme
8. Menubar receives URL, decodes cert, writes to `~/.ssh/cassh_{connection}_id_ed25519-cert.pub`
9. Runs `ssh-add`, dropdown menu shows green status indicator

### Personal Flow (SSH Keys via gh CLI)

1. User launches app → Setup wizard opens (first run)
2. User selects "Personal GitHub.com" and enters GitHub username
3. Menubar generates Ed25519 SSH key (`~/.ssh/cassh_personal_{id}_id_ed25519`)
4. Key is uploaded to GitHub via `gh ssh-key add`
5. `~/.ssh/config` is automatically configured for GitHub.com
6. Key age is tracked; rotation happens per user-selected policy
7. On rotation: old key deleted from GitHub, new key generated and uploaded

### Enterprise Setup Flow

1. User clicks "Add Enterprise Connection" in setup wizard
2. User pastes any SSH clone URL from their GitHub Enterprise (e.g., `user_123@github.company.com:org/repo.git`)
3. JavaScript parses URL to extract: hostname (`github.company.com`) and SSH username (`user_123`)
4. User enters cassh server URL and optional git identity (name/email)
5. Connection is saved with SCIM-provisioned username
6. SSH config is created with correct `User` field (not `git`, but actual SCIM username)
7. Git config `includeIf` is added to `~/.gitconfig` if git identity was provided

## Git Config Management

cassh manages per-connection git identities using Git's `includeIf` directive:

**Per-connection config files** (stored in `~/.config/cassh/`):
```
gitconfig-enterprise-1733525000
gitconfig-personal-1733526000
```

Each contains:
```ini
# Git config for Work GitHub (github.company.com)
[user]
    name = John Doe
    email = john.doe@company.com
```

**Conditional includes** added to `~/.gitconfig`:
```ini
# cassh: Include config for Work GitHub
[includeIf "hasconfig:remote.*.url:user_123@github.company.com:**"]
    path = /Users/john/.config/cassh/gitconfig-enterprise-1733525000

# cassh: Include config for Personal GitHub
[includeIf "hasconfig:remote.*.url:git@github.com:**"]
    path = /Users/john/.config/cassh/gitconfig-personal-1733526000
```

Git automatically applies the correct identity based on the repo's remote URL.

## URL Scheme

cassh registers the `cassh://` URL scheme for certificate installation:

- **Scheme**: `cassh://install-cert?cert=<base64-encoded-cert>&connection=<id>`
- **Handler**: `cmd/cassh-menubar/urlhandler_darwin.go`
- **Registration**: `CFBundleURLTypes` in `Info.plist.template`

This bypasses browser mixed-content restrictions when the cassh server runs on HTTPS.

## Static Assets

Place meme images in `cmd/cassh-server/static/images/`:
- `lsp.png` - Lumpy Space Princess
- `sloth.png` - Flash from Zootopia

Templates fall back to emoji if images missing.

## Menu Bar App UI

### Menu Structure

```
[Connection Name]: [Status] (disabled status label)
  Generate / Renew (or "Refresh Key" for personal)
  Revoke Certificate (disabled until cert active)
---
+ Add Connection...
Settings...
---
Help >
  Documentation
  Report a Bug
  Request a Feature
Community >
  Contribute
  Sponsor
  Share cassh...
Appearance >
  [x] Show in Dock
---
Check for Updates...
About cassh
---
Uninstall cassh...
Quit
```

### Native UI Components

- **Setup Window**: WebKit WebView with seamless titlebar, screen-height sizing, Edit menu for copy/paste
- **Share Dialog**: Native NSWindow with copy button and animated checkmark
- **About Window**: Native NSWindow with app icon, version, and links
- **Update Dialog**: AppleScript `display dialog` for native appearance without CGO threading issues

### Dock Visibility

The app can run as:
- **Menu bar only** (accessory mode): `NSApplicationActivationPolicyAccessory`
- **Menu bar + Dock** (regular mode): `NSApplicationActivationPolicyRegular`

User preference saved in `config.toml` as `show_in_dock = true/false`.
- please also ensure that all tests are easily findable and
  indexable, and please have a working README.md doc in the
  directory where tests are stored that is always updated
  accordingly when new tests are added